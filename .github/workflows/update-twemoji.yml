name: Update Twemoji

on:
  # Run monthly on the 1st at 00:00 UTC
  schedule:
    - cron: '0 0 1 * *'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  update-twemoji:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install optimization tools
        run: |
          npm install -g svgo
          sudo apt-get update
          sudo apt-get install -y pngquant optipng
          
      - name: Fetch latest Twemoji release
        id: twemoji
        run: |
          # Get latest release info from jdecked/twemoji
          RELEASE_DATA=$(curl -s https://api.github.com/repos/jdecked/twemoji/releases/latest)
          LATEST_VERSION=$(echo "$RELEASE_DATA" | jq -r '.tag_name')
          RELEASE_URL=$(echo "$RELEASE_DATA" | jq -r '.html_url')
          
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "url=$RELEASE_URL" >> $GITHUB_OUTPUT
          echo "Latest Twemoji version: $LATEST_VERSION"
          
          # Check if we already have this version
          if [ -f ".twemoji-version" ]; then
            CURRENT_VERSION=$(cat .twemoji-version | tr -d '[:space:]')
            LATEST_VERSION_TRIMMED=$(echo "$LATEST_VERSION" | tr -d '[:space:]')
            if [ "$CURRENT_VERSION" = "$LATEST_VERSION_TRIMMED" ]; then
              echo "Already on latest version $LATEST_VERSION"
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          echo "skip=false" >> $GITHUB_OUTPUT
          
      - name: Download Twemoji assets
        if: steps.twemoji.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.twemoji.outputs.version }}"
          
          # Clone the Twemoji repository at the specific tag
          git clone --depth 1 --branch "$VERSION" https://github.com/jdecked/twemoji.git /tmp/twemoji
          
          # Create temporary directories for processing
          mkdir -p /tmp/optimized/svg
          mkdir -p /tmp/optimized/png
          
      - name: Optimize SVG files
        if: steps.twemoji.outputs.skip != 'true'
        run: |
          echo "Optimizing SVG files..."
          
          # Find SVG assets directory in Twemoji repo
          if [ -d "/tmp/twemoji/assets/svg" ]; then
            SVG_SOURCE="/tmp/twemoji/assets/svg"
          elif [ -d "/tmp/twemoji/svg" ]; then
            SVG_SOURCE="/tmp/twemoji/svg"
          else
            echo "Error: Could not find SVG directory in Twemoji repository"
            find /tmp/twemoji -type d -name "*svg*" | head -10
            exit 1
          fi
          
          # Count files before optimization
          TOTAL_SVG=$(find "$SVG_SOURCE" -name "*.svg" | wc -l)
          echo "Found $TOTAL_SVG SVG files to optimize"
          
          # Optimize SVG files with SVGO
          find "$SVG_SOURCE" -name "*.svg" -exec svgo --multipass {} --output /tmp/optimized/svg/{/} \;
          
          # Verify optimization
          OPTIMIZED_COUNT=$(find /tmp/optimized/svg -name "*.svg" | wc -l)
          echo "Optimized $OPTIMIZED_COUNT SVG files"
          
      - name: Optimize PNG files
        if: steps.twemoji.outputs.skip != 'true'
        run: |
          echo "Optimizing PNG files..."
          
          # Find PNG assets directory in Twemoji repo
          if [ -d "/tmp/twemoji/assets/72x72" ]; then
            PNG_SOURCE="/tmp/twemoji/assets/72x72"
          elif [ -d "/tmp/twemoji/72x72" ]; then
            PNG_SOURCE="/tmp/twemoji/72x72"
          elif [ -d "/tmp/twemoji/assets" ]; then
            PNG_SOURCE="/tmp/twemoji/assets"
          else
            echo "Error: Could not find PNG directory in Twemoji repository"
            find /tmp/twemoji -type d | head -20
            exit 1
          fi
          
          # Count files before optimization
          TOTAL_PNG=$(find "$PNG_SOURCE" -name "*.png" | wc -l)
          echo "Found $TOTAL_PNG PNG files to optimize"
          
          # Copy PNG files to temp directory
          find "$PNG_SOURCE" -name "*.png" -exec cp {} /tmp/optimized/png/ \;
          
          # Verify we have files to optimize
          COPIED_COUNT=$(find /tmp/optimized/png -name "*.png" | wc -l)
          if [ "$COPIED_COUNT" -eq 0 ]; then
            echo "Error: No PNG files found to optimize"
            exit 1
          fi
          
          # Optimize PNG files with pngquant (lossy compression)
          # Using quality 80-95 for good balance between size and quality
          cd /tmp/optimized/png
          PNG_FILES=$(find . -maxdepth 1 -name "*.png" -type f)
          if [ -n "$PNG_FILES" ]; then
            find . -maxdepth 1 -name "*.png" -type f -exec pngquant --quality=80-95 --ext .png --force {} \; || echo "Warning: Some PNG files could not be optimized with pngquant"
          fi
          
          # Further optimize with optipng (lossless)
          if [ -n "$PNG_FILES" ]; then
            find . -maxdepth 1 -name "*.png" -type f -exec optipng -o2 {} \;
          fi
          
          # Verify optimization
          OPTIMIZED_COUNT=$(find /tmp/optimized/png -name "*.png" | wc -l)
          echo "Optimized $OPTIMIZED_COUNT PNG files"
          
      - name: Update repository images
        if: steps.twemoji.outputs.skip != 'true'
        id: update
        run: |
          echo "Updating repository with optimized images..."
          
          # Verify we have optimized files to copy
          SVG_OPTIMIZED=$(find /tmp/optimized/svg -name "*.svg" | wc -l)
          PNG_OPTIMIZED=$(find /tmp/optimized/png -name "*.png" | wc -l)
          
          if [ "$SVG_OPTIMIZED" -eq 0 ] && [ "$PNG_OPTIMIZED" -eq 0 ]; then
            echo "Error: No optimized files found to copy"
            exit 1
          fi
          
          # Remove old images using find to handle empty directories gracefully
          if [ -d "images/svg" ]; then
            find images/svg -type f -name "*.svg" -delete 2>/dev/null || true
          fi
          if [ -d "images/png" ]; then
            find images/png -type f -name "*.png" -delete 2>/dev/null || true
          fi
          
          # Ensure directories exist
          mkdir -p images/svg images/png
          
          # Copy optimized files if they exist
          if [ "$SVG_OPTIMIZED" -gt 0 ]; then
            find /tmp/optimized/svg -type f -name "*.svg" -exec cp {} images/svg/ \;
          fi
          if [ "$PNG_OPTIMIZED" -gt 0 ]; then
            find /tmp/optimized/png -type f -name "*.png" -exec cp {} images/png/ \;
          fi
          
          # Update version file
          echo "${{ steps.twemoji.outputs.version }}" > .twemoji-version
          
          # Show statistics
          SVG_COUNT=$(find images/svg/ -maxdepth 1 -name "*.svg" -type f 2>/dev/null | wc -l)
          PNG_COUNT=$(find images/png/ -maxdepth 1 -name "*.png" -type f 2>/dev/null | wc -l)
          SVG_SIZE=$(du -sh images/svg 2>/dev/null | cut -f1 || echo "0")
          PNG_SIZE=$(du -sh images/png 2>/dev/null | cut -f1 || echo "0")
          
          echo "svg_count=$SVG_COUNT" >> $GITHUB_OUTPUT
          echo "png_count=$PNG_COUNT" >> $GITHUB_OUTPUT
          echo "svg_size=$SVG_SIZE" >> $GITHUB_OUTPUT
          echo "png_size=$PNG_SIZE" >> $GITHUB_OUTPUT
          
          echo "Updated images:"
          echo "SVG files: $SVG_COUNT (size: $SVG_SIZE)"
          echo "PNG files: $PNG_COUNT (size: $PNG_SIZE)"
          
      - name: Create Pull Request
        if: steps.twemoji.outputs.skip != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Update Twemoji to ${{ steps.twemoji.outputs.version }}"
          title: "Update Twemoji to ${{ steps.twemoji.outputs.version }}"
          body: |
            This PR updates the Twemoji emoji assets to version ${{ steps.twemoji.outputs.version }}.
            
            ## Changes
            - Updated SVG emoji files from [jdecked/twemoji](${{ steps.twemoji.outputs.url }})
            - Updated PNG emoji files from [jdecked/twemoji](${{ steps.twemoji.outputs.url }})
            - Optimized SVG files using SVGO
            - Optimized PNG files using pngquant and optipng
            
            ## Statistics
            - SVG files: ${{ steps.update.outputs.svg_count }} (size: ${{ steps.update.outputs.svg_size }})
            - PNG files: ${{ steps.update.outputs.png_count }} (size: ${{ steps.update.outputs.png_size }})
            
            Please review and merge if the updated emoji assets look good.
          branch: update-twemoji-${{ steps.twemoji.outputs.version }}
          delete-branch: true
          labels: |
            enhancement
            automated
